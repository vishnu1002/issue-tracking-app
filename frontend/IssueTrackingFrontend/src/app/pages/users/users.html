<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold text-gray-100">Users Management</h2>
    <button
      class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium cursor-pointer shadow-sm ring-1 ring-indigo-500/30"
      (click)="loadUsers()"
      title="Reload users"
      aria-label="Reload users"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="size-4"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"
        />
      </svg>

      Refresh
    </button>
  </div>

  <!-- Search and Filter Section -->
  <div class="bg-gray-800 p-2 rounded-xl shadow">
    <div class="flex flex-wrap gap-3 items-end justify-center">
      <div class="flex-1 min-w-48 relative">
        <svg
          class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z"
          />
        </svg>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          placeholder="Search users..."
          class="w-full pl-9 pr-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"
        />
      </div>

      <div class="min-w-32">
        <select
          [(ngModel)]="roleFilter"
          (change)="applyFilters()"
          class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"
        >
          <option value="">All Roles</option>
          <option value="User">User</option>
          <option value="Rep">Rep</option>
          <option value="Admin">Admin</option>
        </select>
      </div>

      <button
        (click)="clearFilters()"
        class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-600 hover:bg-gray-500 rounded-md transition-colors cursor-pointer"
      >
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex justify-center items-center py-8">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
    <span class="ml-2 text-gray-400">Loading users...</span>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="bg-red-800/50 border border-red-600 text-red-200 px-4 py-3 rounded-md">
    {{ error }}
  </div>

  <!-- Users Table -->
  <div *ngIf="!loading && !error" class="bg-gray-800 rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-700">
        <thead class="bg-gray-700/80 backdrop-blur">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              ID
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              Email
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              Tickets
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              Role
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              Created At
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-gray-800 divide-y divide-gray-700">
          <tr *ngFor="let user of filteredUsers" class="hover:bg-gray-700/60">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
              {{ user.id }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
              <div class="flex items-center gap-3">
                <div
                  class="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-600/20 text-indigo-300 border border-indigo-700/40"
                >
                  {{ user.name || user.email || '?' | slice : 0 : 1 | uppercase }}
                </div>
                <span>{{ user.name }}</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
              <a
                class="hover:text-indigo-300 underline underline-offset-2"
                [href]="'mailto:' + user.email"
                >{{ user.email }}</a
              >
            </td>
            <td class="px-6 py-5 whitespace-nowrap text-sm text-gray-300">
              <span
                class="inline-flex items-center gap-4 px-2 py-0.5 rounded-full bg-gray-700 text-gray-200 border border-gray-600"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  class="size-4"
                >
                  <path
                    fill-rule="evenodd"
                    d="M1.5 6.375c0-1.036.84-1.875 1.875-1.875h17.25c1.035 0 1.875.84 1.875 1.875v3.026a.75.75 0 0 1-.375.65 2.249 2.249 0 0 0 0 3.898.75.75 0 0 1 .375.65v3.026c0 1.035-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 0 1 1.5 17.625v-3.026a.75.75 0 0 1 .374-.65 2.249 2.249 0 0 0 0-3.898.75.75 0 0 1-.374-.65V6.375Zm15-1.125a.75.75 0 0 1 .75.75v.75a.75.75 0 0 1-1.5 0V6a.75.75 0 0 1 .75-.75Zm.75 4.5a.75.75 0 0 0-1.5 0v.75a.75.75 0 0 0 1.5 0v-.75Zm-.75 3a.75.75 0 0 1 .75.75v.75a.75.75 0 0 1-1.5 0v-.75a.75.75 0 0 1 .75-.75Zm.75 4.5a.75.75 0 0 0-1.5 0V18a.75.75 0 0 0 1.5 0v-.75ZM6 12a.75.75 0 0 1 .75-.75H12a.75.75 0 0 1 0 1.5H6.75A.75.75 0 0 1 6 12Zm.75 2.25a.75.75 0 0 0 0 1.5h3a.75.75 0 0 0 0-1.5h-3Z"
                    clip-rule="evenodd"
                  />
                </svg>

                {{ ticketCounts[user.id] || 0 }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap relative">
              <span
                class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold rounded-full cursor-pointer select-none"
                [ngClass]="{
                  'bg-green-100 text-green-800': user.role === 'User',
                  'bg-blue-100 text-blue-800': user.role === 'Rep',
                  'bg-purple-100 text-purple-800': user.role === 'Admin'
                }"
                (click)="
                  (user.role === 'User' || user.role === 'Rep') && toggleRolePopover(user.id)
                "
                title="Click to change role"
                aria-haspopup="true"
                [attr.aria-expanded]="rolePopoverForId === user.id"
              >
                <svg
                  *ngIf="user.role === 'User'"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  class="size-4"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
                  />
                </svg>

                <svg
                  *ngIf="user.role === 'Rep'"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  class="size-4"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
                  />
                </svg>

                <svg
                  *ngIf="user.role === 'Admin'"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  class="size-4"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"
                  />
                </svg>

                {{ user.role }}
              </span>

              <!-- Popover: for User show Rep option; for Rep show User option -->
              <div
                *ngIf="
                  (user.role === 'User' || user.role === 'Rep') && rolePopoverForId === user.id
                "
                class="absolute left-full top-1/2 transform -translate-y-1/2 -ml-15 z-20"
                (click)="$event.stopPropagation()"
              >
                <div class="relative">
                  <ng-container [ngSwitch]="user.role">
                    <button
                      *ngSwitchCase="'User'"
                      (click)="confirmPromote(user)"
                      class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 border border-blue-300 shadow cursor-pointer"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                        class="size-4"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
                          clip-rule="evenodd"
                        />
                      </svg>
                      Rep
                    </button>
                    <button
                      *ngSwitchCase="'Rep'"
                      (click)="confirmDemote(user)"
                      class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-300 shadow cursor-pointer"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="size-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"
                        />
                      </svg>
                      User
                    </button>
                  </ng-container>

                  <div
                    class="absolute right-full top-1/2 transform -translate-y-1/2 h-0 w-0 border-y-4 border-y-transparent border-r-4 border-r-gray-300"
                  ></div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
              <div class="flex flex-col">
                <span>{{ user.createdAt | date : 'dd/MM/yyyy' }}</span>
                <span class="text-gray-400 text-xs">{{ user.createdAt | date : 'HH:mm' }}</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button
                (click)="deleteUser(user)"
                class="group inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-rose-100 bg-rose-900/40 hover:bg-rose-900/60 border border-rose-800/60 rounded-md transition-all cursor-pointer shadow-sm ring-1 ring-rose-500/20 hover:ring-rose-400/30 hover:shadow-rose-900/20"
                title="Delete user"
                aria-label="Delete user"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  class="size-4"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                  />
                </svg>

                <span>Delete</span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Click-outside overlay to close popover -->
    <div *ngIf="rolePopoverForId" class="fixed inset-0 z-10" (click)="closeRolePopover()"></div>

    <!-- Empty State -->
    <div *ngIf="filteredUsers.length === 0" class="text-center py-8">
      <p class="text-gray-400">No users found</p>
    </div>
  </div>
</div>
